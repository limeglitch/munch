<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Mucnh</title>
<!-- Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø® compat Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ù† Ù…Ù„Ù HTML Ù…Ø¨Ø§Ø´Ø±Ø© -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
  body{font-family:Tahoma, Arial; background:#0b1220; color:#fff; margin:0; padding:20px}
  .wrap{max-width:760px;margin:0 auto}
  h1{margin:6px 0 18px;text-align:center}
  .card{background:#0f1724;padding:16px;border-radius:10px;border:1px solid #1f2a44;margin-bottom:14px}
  input, button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #294157;background:#071126;color:#fff}
  button{cursor:pointer;background:#0ea5a4;border:none}
  button.danger{background:#ef4444}
  .muted{color:#94a3b8;font-size:13px}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  .product{display:inline-block;background:#071024;padding:8px;border-radius:8px;margin:8px;border:1px solid #172554;width:200px;text-align:center;vertical-align:top}
  img.thumb{width:100%;height:120px;object-fit:cover;border-radius:6px}
  #logs{white-space:pre-wrap;margin-top:10px;color:#ffcc80}
  progress{width:100%;height:14px;border-radius:6px;overflow:hidden}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† â€” Mucnh</h1>

    <div id="loginCard" class="card">
      <h3>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h3>
      <input id="adminCode" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø£Ø¯Ù…Ù†" />
      <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
      <p class="muted">Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­ ÙÙ‚Ø· Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„ØµØ­ÙŠØ­.</p>
    </div>

    <div id="adminPanel" class="card hidden">
      <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>

      <form id="productForm">
        <input id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required />
        <input id="pPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)" required />
        <input id="pDiscount" type="number" placeholder="Ø®ØµÙ… % (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
        <input id="pImage" type="file" accept="image/*" required />
        <button id="addBtn" type="submit">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
      </form>

      <div id="uploader" class="card hidden">
        <p class="muted">Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...</p>
        <progress id="progress" value="0" max="100"></progress>
        <div id="progressText" class="muted"></div>
      </div>

      <h3 style="margin-top:14px">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
      <div id="productsContainer"></div>
    </div>

    <div id="logs" class="muted"></div>
  </div>

<script>
  try {
    // === Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (ØªØ£ÙƒØ¯ Ø£Ù† storageBucket Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDxwgtbrA2RVCwEwbn5_FDRJ20cN-IYAl0",
      authDomain: "cif225.firebaseapp.com",
      projectId: "cif225",
      storageBucket: "cif225.appspot.com",
      messagingSenderId: "852933662256",
      appId: "1:852933662256:web:e9ba1b9911f3b2e1ed3ff5",
      measurementId: "G-J9WTSQ00YL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
  } catch (e) {
    console.error('firebase init error', e);
    document.getElementById('logs').textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase â€” Ø±Ø§Ø¬Ø¹ Console';
  }

  // Ø¹Ù†Ø§ØµØ± DOM
  const ADMIN_CODE = '286791';
  const loginBtn = document.getElementById('loginBtn');
  const adminCodeEl = document.getElementById('adminCode');
  const loginCard = document.getElementById('loginCard');
  const adminPanel = document.getElementById('adminPanel');

  const productForm = document.getElementById('productForm');
  const pName = document.getElementById('pName');
  const pPrice = document.getElementById('pPrice');
  const pDiscount = document.getElementById('pDiscount');
  const pImage = document.getElementById('pImage');
  const addBtn = document.getElementById('addBtn');

  const uploader = document.getElementById('uploader');
  const progressEl = document.getElementById('progress');
  const progressText = document.getElementById('progressText');
  const productsContainer = document.getElementById('productsContainer');
  const logs = document.getElementById('logs');

  // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
  loginBtn.addEventListener('click', () => {
    const v = (adminCodeEl.value || '').trim();
    if (v === ADMIN_CODE) {
      loginCard.classList.add('hidden');
      adminPanel.classList.remove('hidden');
      startProductsListener();
      logs.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ£Ø¯Ù…Ù† â€” ØªØ§Ø¨Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ø¯Ù†Ø§Ù‡.';
      console.log('admin logged in');
    } else {
      alert('ÙƒÙˆØ¯ Ø§Ù„Ø£Ø¯Ù…Ù† ØºÙŠØ± ØµØ­ÙŠØ­');
    }
  });

  // Start listening to products (real-time)
  let unsubscribe = null;
  function startProductsListener() {
    try {
      const q = db.collection('products').orderBy('createdAt','desc');
      unsubscribe = q.onSnapshot(snapshot => {
        productsContainer.innerHTML = '';
        snapshot.forEach(doc => {
          const p = doc.data();
          const id = doc.id;
          const div = document.createElement('div');
          div.className = 'product';
          div.innerHTML = `
            <img class="thumb" src="${p.imageUrl || ''}" alt="${escapeHtml(p.name||'')}" />
            <div style="padding-top:8px"><strong>${escapeHtml(p.name||'')}</strong></div>
            <div class="muted">Ø§Ù„Ø³Ø¹Ø±: ${escapeHtml(String(p.price||''))} Ø¬.Ù…</div>
            <div class="muted">Ø®ØµÙ…: ${escapeHtml(String(p.discount||0))}%</div>
            <div style="margin-top:8px;display:flex;gap:6px;justify-content:center">
              <button data-id="${id}" data-path="${escapeHtml(p.storagePath||'')}" class="delBtn danger">Ø­Ø°Ù</button>
            </div>
          `;
          productsContainer.appendChild(div);

          // delete handler
          div.querySelector('.delBtn').addEventListener('click', async (ev) => {
            const idToDelete = ev.currentTarget.getAttribute('data-id');
            const storagePath = ev.currentTarget.getAttribute('data-path');
            if (!confirm('Ù…ØªØ£ÙƒØ¯ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
            try {
              await db.collection('products').doc(idToDelete).delete();
              if (storagePath) {
                await storage.ref(storagePath).delete().catch(()=>{});
              }
              console.log('product deleted', idToDelete);
            } catch (err) {
              console.error('delete error', err);
              alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù â€” Ø§ÙØªØ­ Console Ù„Ù„Ù…Ø²ÙŠØ¯');
            }
          });
        });
      }, err => {
        console.error('onSnapshot error', err);
        logs.textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ø±Ø§Ø¬Ø¹ Console';
      });
    } catch (err) {
      console.error('startProductsListener error', err);
      logs.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª â€” Ø±Ø§Ø¬Ø¹ Console';
    }
  }

  // handle add product (form submit)
  productForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    addBtn.disabled = true;
    logs.textContent = '';

    const name = (pName.value||'').trim();
    const price = Number(pPrice.value);
    const discount = Number(pDiscount.value || 0);
    const file = pImage.files[0];

    if (!name || !price || !file) {
      alert('Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ø®ØªØ± ØµÙˆØ±Ø©');
      addBtn.disabled = false;
      return;
    }

    try {
      // show uploader
      uploader.classList.remove('hidden');
      progressEl.value = 0;
      progressText.textContent = '0%';
      // create unique storage path
      const safeName = file.name.replace(/\s/g,'_');
      const storagePath = `products/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${safeName}`;
      const storageRef = storage.ref(storagePath);
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed',
        snapshot => {
          const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
          progressEl.value = pct;
          progressText.textContent = `Ø±ÙØ¹ ${pct}%`;
        },
        error => {
          console.error('upload error', error);
          logs.textContent = 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© â€” Ø§ÙØªØ­ Console Ù„Ù„ØªÙØ§ØµÙŠÙ„';
          alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + (error.message || error));
          addBtn.disabled = false;
          uploader.classList.add('hidden');
        },
        async () => {
          try {
            const imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
            // save doc with storagePath so we can delete file later
            await db.collection('products').add({
              name,
              price,
              discount,
              imageUrl,
              storagePath,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            logs.textContent = 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­ âœ…';
            productForm.reset();
            uploader.classList.add('hidden');
            addBtn.disabled = false;
          } catch (err2) {
            console.error('after upload error', err2);
            logs.textContent = 'Ø®Ø·Ø£ Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© â€” Ø±Ø§Ø¬Ø¹ Console';
            addBtn.disabled = false;
            uploader.classList.add('hidden');
          }
        }
      );
    } catch (err) {
      console.error('add product error', err);
      logs.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¹Ø§Ù… â€” Ø§ÙØªØ­ Console';
      alert('Ø®Ø·Ø£: ' + (err.message || err));
      addBtn.disabled = false;
      uploader.classList.add('hidden');
    }
  });

  // small helper
  function escapeHtml(s){ return String(s||'').replace(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":\"&#39;\",'`':'&#96;'}[c])); }

  // helpful debug hints shown on page
  logs.textContent = 'Ù„Ùˆ Ø§Ù„Ø²Ø± Ù„Ø§ ÙŠØ³ØªØ¬ÙŠØ¨: Ø§ÙØªØ­ Developer Console (F12) ÙˆØ§Ù†Ø³Ø® Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù‡Ù†Ø§.\nØ¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ permission-denied ÙØªØ­ Ù‚ÙˆØ§Ø¹Ø¯ Firestore/Storage Ù…Ø¤Ù‚ØªØ© Ù„Ø§Ø²Ù…Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©.';
</script>
</body>
          </html>
